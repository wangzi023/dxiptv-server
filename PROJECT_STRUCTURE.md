# ğŸ“ é¡¹ç›®å·¥ç¨‹åŒ–é‡æ„å®Œæˆ

## ğŸ¯ é‡æ„ç›®æ ‡
- âœ… æ¨¡å—åŒ–è®¾è®¡ - æ¸…æ™°çš„é¡¹ç›®ç»“æ„
- âœ… èŒè´£åˆ†ç¦» - å„å±‚ç‹¬ç«‹è§£è€¦
- âœ… æ˜“äºç»´æŠ¤ - ä»£ç ç»„ç»‡æœ‰åº
- âœ… æ˜“äºæ‰©å±• - æ–°åŠŸèƒ½å¼€å‘ä¾¿åˆ©
- âœ… å¯é…ç½®åŒ– - æ”¯æŒå¤šç¯å¢ƒé…ç½®

## ğŸ“ æ–°é¡¹ç›®ç»“æ„

```
d:\itcast\dxiptv-server\
â”œâ”€â”€ app/                          # åº”ç”¨åŒ…
â”‚   â”œâ”€â”€ __init__.py              # åº”ç”¨åˆå§‹åŒ–
â”‚   â”œâ”€â”€ factory.py               # åº”ç”¨å·¥å‚ï¼ˆåˆ›å»ºFlaskåº”ç”¨ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                  # æ•°æ®å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ database.py          # æ•°æ®åº“åˆå§‹åŒ–å’Œç»“æ„
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user_service.py      # ç”¨æˆ·å’Œç®¡ç†å‘˜ä¸šåŠ¡é€»è¾‘
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                  # è·¯ç”±å±‚ï¼ˆAPIç«¯ç‚¹ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py              # è®¤è¯ç›¸å…³è·¯ç”±
â”‚   â”‚   â””â”€â”€ admin.py             # ç®¡ç†å‘˜ç›¸å…³è·¯ç”±
â”‚   â”‚
â”‚   â””â”€â”€ utils/                   # å·¥å…·å±‚
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ auth.py              # è®¤è¯å·¥å…·ï¼ˆJWTã€å¯†ç å“ˆå¸Œï¼‰
â”‚       â”œâ”€â”€ database.py          # æ•°æ®åº“å·¥å…·ï¼ˆè¿æ¥ç®¡ç†ï¼‰
â”‚       â””â”€â”€ logger.py            # æ—¥å¿—å·¥å…·
â”‚
â”œâ”€â”€ public/                      # å‰ç«¯é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ index.html              # ä¸»é¡µé¢
â”‚   â”œâ”€â”€ login.html              # ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ admin.html              # ç®¡ç†å‘˜é¡µé¢
â”‚   â”œâ”€â”€ app.js                  # åº”ç”¨ä¸»é€»è¾‘
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ config.py                   # å…¨å±€é…ç½®ç®¡ç†
â”œâ”€â”€ app_new.py                  # æ–°çš„åº”ç”¨å…¥å£ï¼ˆæ›¿ä»£ app.pyï¼‰
â”œâ”€â”€ requirements.txt            # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚ç»“æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Frontend (HTML/JS/CSS)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Routes (è“å›¾)                   â”‚
â”‚  â”œâ”€â”€ /api/auth/*    (è®¤è¯è·¯ç”±)                   â”‚
â”‚  â””â”€â”€ /api/admins/*  (ç®¡ç†å‘˜è·¯ç”±)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Services (ä¸šåŠ¡é€»è¾‘)               â”‚
â”‚  â”œâ”€â”€ UserService    (ç”¨æˆ·æœåŠ¡)                   â”‚
â”‚  â””â”€â”€ AdminService   (ç®¡ç†å‘˜æœåŠ¡)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 Utils (å·¥å…·å±‚)                   â”‚
â”‚  â”œâ”€â”€ auth          (è®¤è¯å·¥å…·)                    â”‚
â”‚  â”œâ”€â”€ database      (æ•°æ®åº“å·¥å…·)                  â”‚
â”‚  â””â”€â”€ logger        (æ—¥å¿—å·¥å…·)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               Models (æ•°æ®æ¨¡å‹)                  â”‚
â”‚  â””â”€â”€ database      (æ•°æ®åº“åˆå§‹åŒ–)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 SQLite3 æ•°æ®åº“                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ å„æ¨¡å—èŒè´£

### Config (é…ç½®å±‚)
- **èŒè´£**: ç®¡ç†åº”ç”¨é…ç½®
- **æ–‡ä»¶**: `config.py`
- **åŠŸèƒ½**:
  - ç¯å¢ƒé…ç½®ï¼ˆå¼€å‘ã€ç”Ÿäº§ã€æµ‹è¯•ï¼‰
  - åº”ç”¨å¸¸æ•°å®šä¹‰
  - è·¯å¾„ç®¡ç†
  - å¯†é’¥ç®¡ç†

### Models (æ•°æ®å±‚)
- **èŒè´£**: å®šä¹‰æ•°æ®ç»“æ„å’Œåˆå§‹åŒ–
- **æ–‡ä»¶**: `app/models/database.py`
- **åŠŸèƒ½**:
  - æ•°æ®åº“è¡¨åˆ›å»º
  - é»˜è®¤æ•°æ®åˆå§‹åŒ–
  - æ•°æ®åº“ç´¢å¼•åˆ›å»º

### Services (ä¸šåŠ¡é€»è¾‘å±‚)
- **èŒè´£**: å°è£…ä¸šåŠ¡é€»è¾‘
- **æ–‡ä»¶**: `app/services/user_service.py`
- **ç±»**:
  - `UserService`: ç”¨æˆ·è®¤è¯ã€ä¿¡æ¯ç®¡ç†
  - `AdminService`: ç®¡ç†å‘˜å¢åˆ æ”¹æŸ¥ã€æƒé™æ£€æŸ¥
- **ä¼˜ç‚¹**:
  - ä¸šåŠ¡é€»è¾‘ä¸è·¯ç”±åˆ†ç¦»
  - æ˜“äºæµ‹è¯•
  - ä»£ç å¤ç”¨

### Routes (è·¯ç”±å±‚)
- **èŒè´£**: å®šä¹‰ API ç«¯ç‚¹
- **æ–‡ä»¶**:
  - `app/routes/auth.py`: è®¤è¯è·¯ç”±
  - `app/routes/admin.py`: ç®¡ç†å‘˜è·¯ç”±
- **åŠŸèƒ½**:
  - HTTP è¯·æ±‚å¤„ç†
  - å‚æ•°éªŒè¯
  - å“åº”æ ¼å¼åŒ–

### Utils (å·¥å…·å±‚)
- **èŒè´£**: æä¾›é€šç”¨å·¥å…·å‡½æ•°
- **æ–‡ä»¶**:
  - `app/utils/auth.py`: JWTã€å¯†ç ç›¸å…³å·¥å…·
  - `app/utils/database.py`: æ•°æ®åº“è¿æ¥ç®¡ç†
  - `app/utils/logger.py`: æ—¥å¿—ç³»ç»Ÿ
- **ä¼˜ç‚¹**:
  - ä»£ç å¤ç”¨
  - ç»Ÿä¸€ç®¡ç†
  - æ˜“äºæ‰©å±•

## ğŸ”„ æ•°æ®æµ

### ç”¨æˆ·ç™»å½•æµç¨‹
```
1. ç”¨æˆ·è¾“å…¥å‡­è¯ (HTMLè¡¨å•)
2. POST /api/auth/login
3. Routes.login() è°ƒç”¨ UserService.authenticate()
4. UserService æŸ¥è¯¢æ•°æ®åº“ (Utils.database)
5. éªŒè¯å¯†ç  (Utils.auth.verify_password)
6. è¿”å›ä»¤ç‰Œå’Œç”¨æˆ·ä¿¡æ¯
7. å‰ç«¯ä¿å­˜ä»¤ç‰Œåˆ° localStorage
```

### ç®¡ç†å‘˜åˆ—è¡¨è¯·æ±‚æµç¨‹
```
1. å‰ç«¯å‘é€è¯·æ±‚ GET /api/admins
2. Routes.get_admins() æ£€æŸ¥ä»¤ç‰Œ (@token_required)
3. Routes è°ƒç”¨ AdminService.get_all_admins()
4. Service è°ƒç”¨ Utils.execute_query()
5. è¿”å›ç®¡ç†å‘˜åˆ—è¡¨
```

## ğŸš€ å¯åŠ¨åº”ç”¨

### å¼€å‘ç¯å¢ƒ
```bash
python app_new.py
# æˆ–
python app_new.py --host 0.0.0.0 --port 3000
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
python app_new.py --production --host 0.0.0.0 --port 3000
```

### æµ‹è¯•ç¯å¢ƒ
```bash
python app_new.py --testing
```

## ğŸ“š æ¨¡å—æ–‡æ¡£

### UserService ç¤ºä¾‹
```python
from app.services import UserService

# éªŒè¯å‡­è¯
user_info = UserService.authenticate('admin', 'password')

# ä¿®æ”¹å¯†ç 
success, message = UserService.change_password(user_id, old_pwd, new_pwd)
```

### AdminService ç¤ºä¾‹
```python
from app.services import AdminService

# è·å–æ‰€æœ‰ç®¡ç†å‘˜
admins = AdminService.get_all_admins()

# åˆ›å»ºæ–°ç®¡ç†å‘˜
success, result = AdminService.create_admin('username', 'password')

# æ›´æ–°ç®¡ç†å‘˜
success, msg = AdminService.update_admin(admin_id, current_user_id, new_password='new_pwd')

# åˆ é™¤ç®¡ç†å‘˜
success, msg = AdminService.delete_admin(admin_id)
```

### è®¤è¯å·¥å…·ç¤ºä¾‹
```python
from app.utils.auth import hash_password, generate_token, token_required

# å¯†ç å“ˆå¸Œ
hashed = hash_password('password')

# ç”Ÿæˆä»¤ç‰Œ
token = generate_token(user_id=1, username='admin')

# è£…é¥°å™¨ä¿æŠ¤è·¯ç”±
@app.route('/api/protected')
@token_required
def protected_route():
    user_id = request.user['user_id']
    return {'user_id': user_id}
```

## âœ… å·¥ç¨‹åŒ–ä¼˜åŠ¿

### 1. æ¸…æ™°çš„ç»„ç»‡
- æ¨¡å—èŒè´£æ˜ç¡®
- ä»£ç æŸ¥æ‰¾å®¹æ˜“
- å±‚æ¬¡ç»“æ„æ¸…æ™°

### 2. æ˜“äºæµ‹è¯•
- ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹
- å¯æ¨¡æ‹Ÿä¾èµ–
- ç¼–å†™å•å…ƒæµ‹è¯•æ–¹ä¾¿

### 3. æ˜“äºæ‰©å±•
- æ·»åŠ æ–°æœåŠ¡: `app/services/new_service.py`
- æ·»åŠ æ–°è·¯ç”±: `app/routes/new_routes.py`
- æ·»åŠ æ–°å·¥å…·: `app/utils/new_utils.py`

### 4. æ˜“äºç»´æŠ¤
- ä»£ç å¤ç”¨æ€§é«˜
- æ”¹åŠ¨å½±å“èŒƒå›´å°
- ç‰ˆæœ¬ç®¡ç†æ¸…æ™°

### 5. ç”Ÿäº§å°±ç»ª
- é…ç½®ç®¡ç†å®Œå–„
- æ—¥å¿—ç³»ç»Ÿå®Œæ•´
- é”™è¯¯å¤„ç†è§„èŒƒ

## ğŸ“ åç»­å·¥ä½œ

### æ·»åŠ æ–°åŠŸèƒ½æ­¥éª¤
1. **å®šä¹‰æœåŠ¡** - åœ¨ `app/services/` åˆ›å»ºæ–°çš„ Service ç±»
2. **å®ç°è·¯ç”±** - åœ¨ `app/routes/` åˆ›å»ºæ–°çš„è“å›¾
3. **æ³¨å†Œè“å›¾** - åœ¨ `app/routes/__init__.py` æ³¨å†Œ
4. **ç¼–å†™æµ‹è¯•** - åœ¨ `tests/` ç›®å½•ç¼–å†™æµ‹è¯•

### ç¤ºä¾‹ï¼šæ·»åŠ "è®¾å¤‡ç®¡ç†"åŠŸèƒ½
```
1. app/services/device_service.py     (è®¾å¤‡ä¸šåŠ¡é€»è¾‘)
2. app/routes/device.py               (è®¾å¤‡APIç«¯ç‚¹)
3. app/routes/__init__.py             (æ³¨å†Œè“å›¾)
4. tests/test_device.py               (å•å…ƒæµ‹è¯•)
```

## ğŸ“ æœ€ä½³å®è·µ

1. **ä¸è¦åœ¨è·¯ç”±ä¸­å†™ä¸šåŠ¡é€»è¾‘** - ä½¿ç”¨ Service å±‚
2. **ä¸è¦ç›´æ¥æ“ä½œæ•°æ®åº“** - ä½¿ç”¨ Utils å·¥å…·å‡½æ•°
3. **ç»Ÿä¸€é”™è¯¯å¤„ç†** - è¿”å›ä¸€è‡´çš„é”™è¯¯æ ¼å¼
4. **è®°å½•æ—¥å¿—** - ä¾¿äºè°ƒè¯•å’Œç›‘æ§
5. **ç¼–å†™æ–‡æ¡£** - ä½¿ç”¨ Docstring å’Œæ³¨é‡Š

---

**ç‰ˆæœ¬**: 3.1.0 (å·¥ç¨‹åŒ–ç‰ˆ)  
**å®Œæˆæ—¶é—´**: 2025-12-30  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
