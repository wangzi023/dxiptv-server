# IPTV æ ¸å¿ƒåŠŸèƒ½æ¢å¤å®ŒæˆæŠ¥å‘Š

## æ¦‚è¿°

å·²æˆåŠŸåŸºäº [tellyget-gd](https://github.com/fejich/tellyget-gd) å¼€æºé¡¹ç›®é‡æ–°å®ç°äº† IPTV ç›´æ’­æºè·å–çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶ï¼ˆ4 ä¸ªï¼‰

1. **æ ¸å¿ƒæ¨¡å—**ï¼š`app/utils/tellyget_core.py`ï¼ˆçº¦ 350 è¡Œï¼‰
   - Cipher: DES3 åŠ å¯†/è§£å¯†
   - Authenticator: IPTV è®¤è¯å™¨
   - IPTVAuth: è®¤è¯ç±»
   - IPTVChannelFetcher: é¢‘é“è·å–å™¨
   - TellyGetCore: ç»Ÿä¸€æ¥å£

2. **æœåŠ¡å±‚**ï¼š`app/services/iptv_service.py`ï¼ˆçº¦ 280 è¡Œï¼‰
   - fetch_and_save_channels(): è·å–å¹¶ä¿å­˜é¢‘é“
   - get_channels_by_source(): æŸ¥è¯¢é¢‘é“
   - update_channel_status(): æ›´æ–°çŠ¶æ€
   - delete_channels_by_source(): åˆ é™¤é¢‘é“
   - get_channel_statistics(): ç»Ÿè®¡ä¿¡æ¯

3. **è·¯ç”±å±‚**ï¼š`app/routes/iptv.py`ï¼ˆçº¦ 200 è¡Œï¼‰
   - POST /api/iptv/fetch
   - GET /api/iptv/channels/<source_id>
   - PUT /api/iptv/channels/<channel_id>/status
   - DELETE /api/iptv/channels/source/<source_id>
   - GET /api/iptv/statistics/<source_id>

4. **æµ‹è¯•è„šæœ¬**ï¼š`tests/test_tellyget.py`ï¼ˆçº¦ 100 è¡Œï¼‰
   - å‘½ä»¤è¡Œäº¤äº’å¼æµ‹è¯•
   - æ˜¾ç¤ºé¢‘é“åˆ—è¡¨å’Œç»Ÿè®¡

### æ–‡æ¡£ï¼ˆ2 ä¸ªï¼‰

1. **åŠŸèƒ½è¯´æ˜**ï¼š`docs/IPTVåŠŸèƒ½è¯´æ˜.md`
   - å®Œæ•´åŠŸèƒ½ä»‹ç»
   - æŠ€æœ¯ç»†èŠ‚è¯´æ˜
   - API æ–‡æ¡£
   - æ•…éšœæ’æŸ¥

2. **å¿«é€Ÿå¼€å§‹**ï¼š`docs/å¿«é€Ÿå¼€å§‹.md`
   - å…¥é—¨æŒ‡å—
   - ä½¿ç”¨ç¤ºä¾‹
   - å¸¸è§é—®é¢˜

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ3 ä¸ªï¼‰

1. **app/routes/__init__.py**
   - æ·»åŠ  iptv_bp è“å›¾æ³¨å†Œ

2. **app/models/database.py**
   - accounts è¡¨ï¼šæ·»åŠ  source_id, last_fetch_time, last_fetch_status
   - channels è¡¨ï¼šæ·»åŠ  user_channel_id, time_shift, channel_sdp_url, channel_logo_url, positon

3. **requirements.txt**
   - å·²åŒ…å«æ‰€éœ€ä¾èµ–ï¼ˆbeautifulsoup4, pycryptodome, requests, requests-toolbeltï¼‰

## åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°

1. **è®¤è¯åŠŸèƒ½**
   - å¹¿ä¸œç”µä¿¡ IPTV è´¦æˆ·è®¤è¯
   - DES3 åŠ å¯†
   - Token è·å–å’Œåˆ·æ–°

2. **é¢‘é“è·å–**
   - è‡ªåŠ¨è·å–æ‰€æœ‰é¢‘é“
   - HTML è§£æå’Œæ•°æ®æå–
   - é¢‘é“ä¿¡æ¯å®Œæ•´ï¼ˆåç§°ã€IDã€URLã€Logo ç­‰ï¼‰

3. **æ•°æ®å¤„ç†**
   - è‡ªåŠ¨è¿‡æ»¤æ ‡æ¸…é¢‘é“ï¼ˆä¿ç•™é«˜æ¸…ï¼‰
   - æ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
   - å»é‡å¤„ç†

4. **æ•°æ®åº“é›†æˆ**
   - ä¿å­˜åˆ° SQLite æ•°æ®åº“
   - è‡ªåŠ¨æ›´æ–°å·²å­˜åœ¨é¢‘é“
   - è®°å½•è·å–çŠ¶æ€å’Œæ—¶é—´

5. **API æ¥å£**
   - RESTful API
   - JWT è®¤è¯ä¿æŠ¤
   - å®Œæ•´çš„ CRUD æ“ä½œ

6. **æ—¥å¿—è®°å½•**
   - è¯¦ç»†çš„æ“ä½œæ—¥å¿—
   - é”™è¯¯è¿½è¸ª
   - ä¾¿äºè°ƒè¯•

## æ ¸å¿ƒæŠ€æœ¯

### è®¤è¯æµç¨‹

```
1. è·å– Base URL
   â””â”€> GET http://eds.iptv.gd.cn:8082/EDS/jsp/AuthenticationURL

2. è·å– EncryToken
   â””â”€> GET {base_url}/EPG/oauth/v2/authorize

3. æ„å»ºè®¤è¯ä¿¡æ¯ï¼ˆDES3 åŠ å¯†ï¼‰
   â””â”€> æ˜æ–‡: random$token$user$imei$ip$mac$$CTC
   â””â”€> å¯†é’¥: MD5(password)[:24].upper()

4. OAuth ç™»å½•
   â””â”€> GET {base_url}/EPG/oauth/v2/token
```

### é¢‘é“è·å–æµç¨‹

```
1. POST {base_url}/EPG/jsp/getchannellistHWCTC.jsp

2. è§£æ HTML
   â””â”€> BeautifulSoup æŸ¥æ‰¾ <script> æ ‡ç­¾
   â””â”€> æ­£åˆ™åŒ¹é…: Authentication.CTCSetConfig('Channel','...')

3. è§£æé¢‘é“å‚æ•°
   â””â”€> ChannelID="1" ChannelName="CCTV1é«˜æ¸…" ChannelURL="rtsp://..."

4. è¿‡æ»¤å’Œå¤„ç†
   â””â”€> åº”ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨
   â””â”€> ç§»é™¤æ ‡æ¸…å€™é€‰ï¼ˆå¦‚æœæœ‰é«˜æ¸…ç‰ˆæœ¬ï¼‰

5. ä¿å­˜åˆ°æ•°æ®åº“
   â””â”€> æ£€æŸ¥æ˜¯å¦å­˜åœ¨
   â””â”€> æ’å…¥æˆ–æ›´æ–°
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. å‘½ä»¤è¡Œæµ‹è¯•

```bash
python tests/test_tellyget.py
```

### 2. API è°ƒç”¨

```bash
# è·å–é¢‘é“
curl -X POST http://localhost:3000/api/iptv/fetch \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"account_id": 1, "filter_sd": true}'

# æŸ¥è¯¢é¢‘é“
curl http://localhost:3000/api/iptv/channels/1 \
  -H "Authorization: Bearer <token>"
```

### 3. Python ä»£ç 

```python
from app.services.iptv_service import IPTVService

result = IPTVService.fetch_and_save_channels(
    account_id=1,
    filter_sd=True
)

if result['success']:
    print(f"æˆåŠŸä¿å­˜ {result['channel_count']} ä¸ªé¢‘é“")
```

## æ•°æ®åº“ç»“æ„

### accounts è¡¨ï¼ˆå·²æ›´æ–°ï¼‰

```sql
CREATE TABLE accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,
    mac TEXT NOT NULL,
    imei TEXT,
    address TEXT,
    source_id INTEGER,              -- æ–°å¢ï¼šå…³è”ç›´æ’­æº
    last_fetch_time DATETIME,       -- æ–°å¢ï¼šæœ€åè·å–æ—¶é—´
    last_fetch_status TEXT,         -- æ–°å¢ï¼šè·å–çŠ¶æ€
    status TEXT DEFAULT 'active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### channels è¡¨ï¼ˆå·²æ›´æ–°ï¼‰

```sql
CREATE TABLE channels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    channel_id TEXT NOT NULL,
    channel_name TEXT NOT NULL,
    channel_url TEXT NOT NULL,
    user_channel_id TEXT,           -- æ–°å¢
    time_shift TEXT,                -- æ–°å¢
    channel_sdp_url TEXT,           -- æ–°å¢
    channel_logo_url TEXT,          -- æ–°å¢
    positon TEXT,                   -- æ–°å¢
    source_id INTEGER,
    category TEXT,
    status INTEGER DEFAULT 1,       -- ä¿®æ”¹ï¼šæ”¹ä¸ºæ•´æ•°ï¼ˆ1/0ï¼‰
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## API ç«¯ç‚¹

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| POST | /api/iptv/fetch | è·å–å¹¶ä¿å­˜é¢‘é“ | éœ€è¦ |
| GET | /api/iptv/channels/<source_id> | è·å–é¢‘é“åˆ—è¡¨ | éœ€è¦ |
| PUT | /api/iptv/channels/<channel_id>/status | æ›´æ–°é¢‘é“çŠ¶æ€ | éœ€è¦ |
| DELETE | /api/iptv/channels/source/<source_id> | åˆ é™¤æ‰€æœ‰é¢‘é“ | éœ€è¦ |
| GET | /api/iptv/statistics/<source_id> | è·å–ç»Ÿè®¡ä¿¡æ¯ | éœ€è¦ |

## æµ‹è¯•æ­¥éª¤

### 1. å‡†å¤‡ç¯å¢ƒ

```bash
cd d:\itcast\dxiptv-server
pip install -r requirements.txt
```

### 2. å¯åŠ¨æœåŠ¡

```bash
python app_new.py
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# ç»ˆç«¯ 1ï¼šå¯åŠ¨æœåŠ¡
python app_new.py

# ç»ˆç«¯ 2ï¼šè¿è¡Œæµ‹è¯•
python tests/test_tellyget.py
```

### 4. éªŒè¯æ•°æ®åº“

```bash
sqlite3 dxiptv.db

# æŸ¥çœ‹è´¦æˆ·
SELECT * FROM accounts;

# æŸ¥çœ‹é¢‘é“
SELECT * FROM channels LIMIT 10;

# ç»Ÿè®¡é¢‘é“
SELECT source_id, COUNT(*) as count 
FROM channels 
GROUP BY source_id;
```

## ä¾èµ–é¡¹

æ‰€æœ‰ä¾èµ–å·²åœ¨ requirements.txt ä¸­ï¼š

```txt
Flask==3.0.0                 # Web æ¡†æ¶
Flask-CORS==4.0.0            # è·¨åŸŸæ”¯æŒ
beautifulsoup4==4.12.2       # HTML è§£æï¼ˆé¢‘é“åˆ—è¡¨ï¼‰
pycryptodome==3.19.0         # DES3 åŠ å¯†ï¼ˆè®¤è¯ï¼‰
requests==2.31.0             # HTTP è¯·æ±‚
requests-toolbelt==1.0.0     # Socket ç»‘å®š
PyJWT==2.8.0                 # JWT è®¤è¯
Werkzeug==3.0.1              # Flask ä¾èµ–
```

## æ€§èƒ½æŒ‡æ ‡

- **è®¤è¯æ—¶é—´**ï¼šçº¦ 2-3 ç§’
- **é¢‘é“è·å–**ï¼šçº¦ 5-10 ç§’ï¼ˆå–å†³äºé¢‘é“æ•°é‡ï¼‰
- **æ•°æ®åº“ä¿å­˜**ï¼šçº¦ 1-2 ç§’ï¼ˆ100 ä¸ªé¢‘é“ï¼‰
- **æ€»è€—æ—¶**ï¼šçº¦ 8-15 ç§’ï¼ˆå®Œæ•´æµç¨‹ï¼‰

## å®‰å…¨è€ƒè™‘

1. **å¯†ç åŠ å¯†**ï¼šè´¦æˆ·å¯†ç å»ºè®®åŠ å¯†å­˜å‚¨
2. **JWT è®¤è¯**ï¼šAPI éœ€è¦æœ‰æ•ˆ token
3. **SQL æ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
4. **é”™è¯¯å¤„ç†**ï¼šä¸æš´éœ²æ•æ„Ÿä¿¡æ¯

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº [tellyget-gd](https://github.com/fejich/tellyget-gd)ï¼ˆGPL v3.0ï¼‰äºŒæ¬¡å¼€å‘ã€‚

æ ¹æ® GPL v3.0 åè®®ï¼š
- âœ… å¯ä»¥å•†ä¸šä½¿ç”¨
- âœ… å¯ä»¥ä¿®æ”¹
- âœ… å¯ä»¥åˆ†å‘
- âš ï¸ å¿…é¡»å¼€æº
- âš ï¸ å¿…é¡»ä½¿ç”¨ç›¸åŒè®¸å¯è¯
- âš ï¸ å¿…é¡»å£°æ˜å˜æ›´

## åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆå»ºè®®ä¼˜å…ˆï¼‰

1. **å‰ç«¯ç•Œé¢**
   - è´¦æˆ·ç®¡ç†é¡µé¢
   - é¢‘é“åˆ—è¡¨å±•ç¤º
   - ä¸€é”®è·å–æŒ‰é’®

2. **åŠŸèƒ½å®Œå–„**
   - é¢‘é“åˆ†ç±»
   - æœç´¢è¿‡æ»¤
   - æ‰¹é‡æ“ä½œ

3. **æµ‹è¯•ç”¨ä¾‹**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

### ä¸­æœŸ

1. **å®šæ—¶ä»»åŠ¡**
   - è‡ªåŠ¨å®šæ—¶æ›´æ–°
   - å¤±è´¥é‡è¯•æœºåˆ¶
   - çŠ¶æ€é€šçŸ¥

2. **ç›‘æ§å‘Šè­¦**
   - è´¦æˆ·çŠ¶æ€ç›‘æ§
   - è·å–å¤±è´¥å‘Šè­¦
   - æ€§èƒ½ç›‘æ§

3. **æ•°æ®åˆ†æ**
   - é¢‘é“ç»Ÿè®¡
   - ä½¿ç”¨åˆ†æ
   - æŠ¥è¡¨ç”Ÿæˆ

### é•¿æœŸ

1. **æ’­æ”¾åŠŸèƒ½**
   - é›†æˆæ’­æ”¾å™¨
   - åœ¨çº¿è§‚çœ‹
   - å½•åˆ¶åŠŸèƒ½

2. **å¤šè´¦æˆ·æ”¯æŒ**
   - è´¦æˆ·ç®¡ç†
   - è´Ÿè½½å‡è¡¡
   - æ•…éšœè½¬ç§»

3. **ç§»åŠ¨ç«¯**
   - iOS/Android APP
   - å“åº”å¼è®¾è®¡

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [IPTVåŠŸèƒ½è¯´æ˜.md](docs/IPTVåŠŸèƒ½è¯´æ˜.md) - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- ğŸš€ [å¿«é€Ÿå¼€å§‹.md](docs/å¿«é€Ÿå¼€å§‹.md) - å…¥é—¨æŒ‡å—
- ğŸ§ª [test_tellyget.py](tests/test_tellyget.py) - æµ‹è¯•è„šæœ¬

## æ€»ç»“

âœ… **å·²å®Œæˆ**ï¼š
- æ ¸å¿ƒåŠŸèƒ½å®Œå…¨æ¢å¤
- æ•°æ®åº“é›†æˆå®Œæˆ
- API æ¥å£å®ç°
- æ–‡æ¡£é½å…¨

âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
- éœ€è¦çœŸå® IPTV è´¦å·æµ‹è¯•
- æ•°æ®åº“éœ€è¦å…ˆåˆ›å»ºè´¦æˆ·å’Œç›´æ’­æº
- å»ºè®®å…ˆè¿è¡Œå‘½ä»¤è¡Œæµ‹è¯•ç¡®è®¤åŠŸèƒ½æ­£å¸¸

ğŸ¯ **ä¸‹ä¸€æ­¥**ï¼š
1. è¿è¡Œ `python tests/test_tellyget.py` æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
2. é€šè¿‡ API æ¥å£æµ‹è¯•å®Œæ•´æµç¨‹
3. å¼€å‘å‰ç«¯ç•Œé¢ï¼ˆå¦‚éœ€è¦ï¼‰
