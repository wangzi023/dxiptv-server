# é¡¹ç›®æ¶æ„è¯´æ˜

## æ•´ä½“æ¶æ„

```
DXIPTV Server (ç”µä¿¡ IPTV ç®¡ç†ç³»ç»Ÿ)
â”œâ”€â”€ 5 å±‚æ¶æ„
â”‚   â”œâ”€â”€ Routes (è·¯ç”±å±‚) - API ç«¯ç‚¹
â”‚   â”œâ”€â”€ Services (æœåŠ¡å±‚) - ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ Models (æ¨¡å‹å±‚) - æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ Utils (å·¥å…·å±‚) - é€šç”¨å·¥å…·
â”‚   â””â”€â”€ Config (é…ç½®å±‚) - é…ç½®ç®¡ç†
â”‚
â”œâ”€â”€ æ ¸å¿ƒåŠŸèƒ½
â”‚   â”œâ”€â”€ ç”¨æˆ·ç®¡ç† (JWT è®¤è¯)
â”‚   â”œâ”€â”€ ç®¡ç†å‘˜ç®¡ç† (CRUD)
â”‚   â””â”€â”€ IPTV ç›´æ’­æºè·å– (åŸºäº tellyget-gd)
â”‚
â””â”€â”€ æŠ€æœ¯æ ˆ
    â”œâ”€â”€ Flask 3.0 (Web æ¡†æ¶)
    â”œâ”€â”€ SQLite3 (æ•°æ®åº“)
    â”œâ”€â”€ JWT (è®¤è¯)
    â””â”€â”€ BeautifulSoup + pycryptodome (IPTV)
```

## ç›®å½•ç»“æ„

```
d:\itcast\dxiptv-server\
â”‚
â”œâ”€â”€ app/                          # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ __init__.py              # åŒ…åˆå§‹åŒ–
â”‚   â”œâ”€â”€ factory.py               # Flask åº”ç”¨å·¥å‚
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                  # è·¯ç”±å±‚ï¼ˆAPI ç«¯ç‚¹ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py         # è“å›¾æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ auth.py             # è®¤è¯è·¯ç”±ï¼ˆç™»å½•/ç™»å‡º/ä¿®æ”¹å¯†ç ï¼‰
â”‚   â”‚   â”œâ”€â”€ admin.py            # ç®¡ç†å‘˜è·¯ç”±ï¼ˆCRUDï¼‰
â”‚   â”‚   â””â”€â”€ iptv.py             # IPTV è·¯ç”±ï¼ˆè·å–é¢‘é“ï¼‰âœ¨æ–°å¢
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                # æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_service.py     # ç”¨æˆ·/ç®¡ç†å‘˜æœåŠ¡
â”‚   â”‚   â””â”€â”€ iptv_service.py     # IPTV æœåŠ¡ âœ¨æ–°å¢
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                  # æ¨¡å‹å±‚ï¼ˆæ•°æ®æ¨¡å‹ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ database.py         # æ•°æ®åº“åˆå§‹åŒ–å’Œè¡¨ç»“æ„
â”‚   â”‚
â”‚   â””â”€â”€ utils/                   # å·¥å…·å±‚ï¼ˆé€šç”¨å·¥å…·ï¼‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ auth.py             # JWT è®¤è¯å’Œå¯†ç åŠ å¯†
â”‚       â”œâ”€â”€ database.py         # æ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢
â”‚       â”œâ”€â”€ logger.py           # æ—¥å¿—é…ç½®
â”‚       â””â”€â”€ tellyget_core.py    # IPTV æ ¸å¿ƒåŠŸèƒ½ âœ¨æ–°å¢
â”‚
â”œâ”€â”€ tests/                       # æµ‹è¯•ç›®å½•
â”‚   â”œâ”€â”€ test_admins.py          # ç®¡ç†å‘˜æµ‹è¯•
â”‚   â”œâ”€â”€ test_auth.py            # è®¤è¯æµ‹è¯•
â”‚   â””â”€â”€ test_tellyget.py        # IPTV æµ‹è¯• âœ¨æ–°å¢
â”‚
â”œâ”€â”€ docs/                        # æ–‡æ¡£ç›®å½• âœ¨æ–°å¢
â”‚   â”œâ”€â”€ IPTVåŠŸèƒ½è¯´æ˜.md         # å®Œæ•´æŠ€æœ¯æ–‡æ¡£
â”‚   â”œâ”€â”€ å¿«é€Ÿå¼€å§‹.md             # å…¥é—¨æŒ‡å—
â”‚   â”œâ”€â”€ æ ¸å¿ƒåŠŸèƒ½æ¢å¤æŠ¥å‘Š.md     # åŠŸèƒ½æ¢å¤è¯´æ˜
â”‚   â””â”€â”€ é¡¹ç›®æ¶æ„.md             # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ public/                      # å‰ç«¯é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ logs/                        # æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ app.log
â”‚   â”œâ”€â”€ tellyget_core.log
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ config.py                    # é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt             # Python ä¾èµ–
â”œâ”€â”€ app_new.py                   # åº”ç”¨å…¥å£ï¼ˆå·¥ç¨‹åŒ–åï¼‰
â”œâ”€â”€ dxiptv.db                    # SQLite æ•°æ®åº“
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

## æ•°æ®æµå‘

### 1. ç”¨æˆ·è®¤è¯æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
   â†“
[auth.py è·¯ç”±]
   â†“
éªŒè¯ç”¨æˆ·åå¯†ç 
   â†“
[user_service.py]
   â†“
æŸ¥è¯¢æ•°æ®åº“
   â†“
[database.py]
   â†“
ç”Ÿæˆ JWT Token
   â†“
[auth.py å·¥å…·]
   â†“
è¿”å› Token
```

### 2. IPTV é¢‘é“è·å–æµç¨‹

```
API è¯·æ±‚ (POST /api/iptv/fetch)
   â†“
[iptv.py è·¯ç”±] - éªŒè¯ JWT Token
   â†“
[iptv_service.py] - è·å–è´¦æˆ·ä¿¡æ¯
   â†“
[tellyget_core.py] - æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
   â”‚
   â”œâ”€> [IPTVAuth] - IPTV è®¤è¯
   â”‚     â”œâ”€> è·å– Base URL
   â”‚     â”œâ”€> è·å– Token
   â”‚     â”œâ”€> DES3 åŠ å¯†
   â”‚     â””â”€> OAuth ç™»å½•
   â”‚
   â””â”€> [IPTVChannelFetcher] - é¢‘é“è·å–
         â”œâ”€> POST è¯·æ±‚é¢‘é“åˆ—è¡¨
         â”œâ”€> BeautifulSoup è§£æ HTML
         â”œâ”€> æ­£åˆ™æå–é¢‘é“ä¿¡æ¯
         â””â”€> è¿‡æ»¤å¤„ç†
   â†“
[iptv_service.py] - ä¿å­˜åˆ°æ•°æ®åº“
   â†“
[database.py] - æ‰§è¡Œ SQL
   â†“
è¿”å›ç»“æœ
```

## æ¨¡å—è¯´æ˜

### Routes å±‚ï¼ˆè·¯ç”±ï¼‰

| æ–‡ä»¶ | è·¯å¾„å‰ç¼€ | è¯´æ˜ | ç«¯ç‚¹æ•° |
|------|----------|------|--------|
| auth.py | /api/auth | ç”¨æˆ·è®¤è¯ | 3 |
| admin.py | /api/admins | ç®¡ç†å‘˜ç®¡ç† | 5 |
| iptv.py | /api/iptv | IPTV åŠŸèƒ½ | 5 |

#### auth.py - è®¤è¯è·¯ç”±

- `POST /api/auth/login` - ç™»å½•
- `POST /api/auth/logout` - ç™»å‡º
- `PUT /api/auth/change-password` - ä¿®æ”¹å¯†ç 

#### admin.py - ç®¡ç†å‘˜è·¯ç”±

- `GET /api/admins` - è·å–ç®¡ç†å‘˜åˆ—è¡¨
- `POST /api/admins` - åˆ›å»ºç®¡ç†å‘˜
- `PUT /api/admins/<id>` - æ›´æ–°ç®¡ç†å‘˜
- `DELETE /api/admins/<id>` - åˆ é™¤ç®¡ç†å‘˜
- `PUT /api/admins/<id>/toggle-active` - åˆ‡æ¢çŠ¶æ€

#### iptv.py - IPTV è·¯ç”± âœ¨

- `POST /api/iptv/fetch` - è·å–å¹¶ä¿å­˜é¢‘é“
- `GET /api/iptv/channels/<source_id>` - è·å–é¢‘é“åˆ—è¡¨
- `PUT /api/iptv/channels/<channel_id>/status` - æ›´æ–°é¢‘é“çŠ¶æ€
- `DELETE /api/iptv/channels/source/<source_id>` - åˆ é™¤é¢‘é“
- `GET /api/iptv/statistics/<source_id>` - è·å–ç»Ÿè®¡

### Services å±‚ï¼ˆæœåŠ¡ï¼‰

#### user_service.py

- `UserService` - ç”¨æˆ·æœåŠ¡
  - `authenticate()` - è®¤è¯ç”¨æˆ·
  - `change_password()` - ä¿®æ”¹å¯†ç 
  
- `AdminService` - ç®¡ç†å‘˜æœåŠ¡
  - `get_all_admins()` - è·å–åˆ—è¡¨
  - `create_admin()` - åˆ›å»º
  - `update_admin()` - æ›´æ–°
  - `delete_admin()` - åˆ é™¤
  - `toggle_admin_active()` - åˆ‡æ¢çŠ¶æ€

#### iptv_service.py âœ¨

- `IPTVService` - IPTV æœåŠ¡
  - `fetch_and_save_channels()` - è·å–å¹¶ä¿å­˜
  - `get_channels_by_source()` - æŸ¥è¯¢é¢‘é“
  - `update_channel_status()` - æ›´æ–°çŠ¶æ€
  - `delete_channels_by_source()` - åˆ é™¤é¢‘é“
  - `get_channel_statistics()` - ç»Ÿè®¡ä¿¡æ¯

### Utils å±‚ï¼ˆå·¥å…·ï¼‰

#### auth.py

- `hash_password()` - å¯†ç å“ˆå¸Œ
- `verify_password()` - å¯†ç éªŒè¯
- `generate_token()` - ç”Ÿæˆ JWT
- `token_required()` - JWT è£…é¥°å™¨

#### database.py

- `get_db_context()` - æ•°æ®åº“ä¸Šä¸‹æ–‡
- `execute_query()` - æ‰§è¡ŒæŸ¥è¯¢
- `execute_update()` - æ‰§è¡Œæ›´æ–°

#### logger.py

- `setup_logger()` - é…ç½®æ—¥å¿—
- `get_logger()` - è·å–æ—¥å¿—å™¨

#### tellyget_core.py âœ¨

- `Cipher` - DES3 åŠ å¯†/è§£å¯†
- `Authenticator` - IPTV è®¤è¯å™¨
- `IPTVAuth` - è®¤è¯ç±»
- `IPTVChannelFetcher` - é¢‘é“è·å–å™¨
- `TellyGetCore` - ç»Ÿä¸€æ¥å£

### Models å±‚ï¼ˆæ¨¡å‹ï¼‰

#### database.py

æ•°æ®åº“è¡¨ç»“æ„ï¼š

1. **users** - ç”¨æˆ·è¡¨
   - ç®¡ç†å‘˜è´¦æˆ·
   - JWT è®¤è¯

2. **accounts** - IPTV è´¦æˆ·è¡¨
   - IPTV ç™»å½•å‡­è¯
   - MAC åœ°å€
   - å…³è”ç›´æ’­æº

3. **sources** - ç›´æ’­æºè¡¨
   - ç›´æ’­æºä¿¡æ¯
   - é¢‘é“ç»Ÿè®¡

4. **channels** - é¢‘é“è¡¨
   - é¢‘é“è¯¦ç»†ä¿¡æ¯
   - URLã€Logo ç­‰

## æŠ€æœ¯é€‰å‹

### åç«¯æ¡†æ¶

- **Flask 3.0**
  - è½»é‡çº§ Web æ¡†æ¶
  - æ˜“äºæ‰©å±•
  - ä¸°å¯Œçš„ç”Ÿæ€

### æ•°æ®åº“

- **SQLite3**
  - åµŒå…¥å¼æ•°æ®åº“
  - é›¶é…ç½®
  - é€‚åˆä¸­å°å‹åº”ç”¨

### è®¤è¯

- **JWT (PyJWT)**
  - æ— çŠ¶æ€è®¤è¯
  - è·¨åŸŸå‹å¥½
  - æ˜“äºæ‰©å±•

### IPTV ç›¸å…³

- **BeautifulSoup4**
  - HTML è§£æ
  - æå–é¢‘é“ä¿¡æ¯

- **pycryptodome**
  - DES3 åŠ å¯†
  - IPTV è®¤è¯

- **requests**
  - HTTP å®¢æˆ·ç«¯
  - Session ç®¡ç†

## å®‰å…¨æœºåˆ¶

### 1. è®¤è¯æˆæƒ

```python
@iptv_bp.route('/fetch', methods=['POST'])
@token_required  # JWT éªŒè¯
def fetch_channels(current_user):
    # åªæœ‰è®¤è¯ç”¨æˆ·æ‰èƒ½è®¿é—®
    pass
```

### 2. å¯†ç å®‰å…¨

```python
# ä½¿ç”¨ Werkzeug çš„ pbkdf2:sha256 å“ˆå¸Œ
password_hash = hash_password(plain_password)
```

### 3. SQL æ³¨å…¥é˜²æŠ¤

```python
# ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
execute_query("SELECT * FROM users WHERE username = ?", (username,))
```

### 4. CORS é…ç½®

```python
CORS(app)  # è·¨åŸŸèµ„æºå…±äº«
```

## æ—¥å¿—ç³»ç»Ÿ

### æ—¥å¿—çº§åˆ«

- **DEBUG**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- **INFO**: ä¸€èˆ¬ä¿¡æ¯
- **WARNING**: è­¦å‘Šä¿¡æ¯
- **ERROR**: é”™è¯¯ä¿¡æ¯
- **CRITICAL**: ä¸¥é‡é”™è¯¯

### æ—¥å¿—æ–‡ä»¶

```
logs/
â”œâ”€â”€ app.log              # åº”ç”¨ä¸»æ—¥å¿—
â”œâ”€â”€ tellyget_core.log    # IPTV æ ¸å¿ƒæ—¥å¿—
â”œâ”€â”€ iptv_service.log     # IPTV æœåŠ¡æ—¥å¿—
â””â”€â”€ ...
```

### æ—¥å¿—æ ¼å¼

```
2024-01-01 12:00:00,000 - app - INFO - åº”ç”¨å¯åŠ¨å®Œæˆ
2024-01-01 12:00:01,000 - tellyget_core - INFO - å¼€å§‹è®¤è¯ IPTV è´¦æˆ·: 0758xxxxxxx
```

## é…ç½®ç®¡ç†

### é…ç½®ç±»

```python
class Config:
    """åŸºç¡€é…ç½®"""
    SECRET_KEY = '...'
    DATABASE_PATH = 'dxiptv.db'
    
class DevelopmentConfig(Config):
    """å¼€å‘ç¯å¢ƒ"""
    DEBUG = True
    
class ProductionConfig(Config):
    """ç”Ÿäº§ç¯å¢ƒ"""
    DEBUG = False
```

### ç¯å¢ƒå˜é‡

```bash
export FLASK_ENV=development  # å¼€å‘ç¯å¢ƒ
export FLASK_ENV=production   # ç”Ÿäº§ç¯å¢ƒ
```

## æ‰©å±•æ€§è®¾è®¡

### 1. è“å›¾æ¨¡å¼

æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹çš„è“å›¾ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½ï¼š

```python
# æ–°å¢åŠŸèƒ½åªéœ€åˆ›å»ºæ–°è“å›¾
from app.routes.new_feature import new_feature_bp
app.register_blueprint(new_feature_bp)
```

### 2. æœåŠ¡å±‚è§£è€¦

ä¸šåŠ¡é€»è¾‘ä¸è·¯ç”±åˆ†ç¦»ï¼Œä¾¿äºæµ‹è¯•å’Œå¤ç”¨ï¼š

```python
# è·¯ç”±å±‚åªè´Ÿè´£è¯·æ±‚å¤„ç†
@iptv_bp.route('/fetch', methods=['POST'])
def fetch_channels(current_user):
    result = IPTVService.fetch_and_save_channels(...)
    return jsonify(result)
```

### 3. æ•°æ®åº“æŠ½è±¡

ä½¿ç”¨å·¥å…·å‡½æ•°å°è£…æ•°æ®åº“æ“ä½œï¼š

```python
# ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£
result = execute_query(sql, params)
```

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ç´¢å¼•

```sql
CREATE INDEX idx_channels_source ON channels(source_id);
```

### 2. è¿æ¥æ± 

```python
# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç®¡ç†è¿æ¥
with get_db_context() as db:
    cursor = db.cursor()
    # æ‰§è¡ŒæŸ¥è¯¢
```

### 3. æ‰¹é‡æ“ä½œ

```python
# æ‰¹é‡æ’å…¥é¢‘é“
for channel in channels:
    execute_update(insert_sql, params)
```

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```bash
pytest tests/test_auth.py        # è®¤è¯æµ‹è¯•
pytest tests/test_admins.py      # ç®¡ç†å‘˜æµ‹è¯•
```

### é›†æˆæµ‹è¯•

```bash
python tests/test_tellyget.py    # IPTV åŠŸèƒ½æµ‹è¯•
```

### æ€§èƒ½æµ‹è¯•

- è®¤è¯å“åº”æ—¶é—´ < 100ms
- API å“åº”æ—¶é—´ < 500ms
- IPTV è·å–æ—¶é—´ < 15s

## éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ

```bash
python app_new.py
# è®¿é—®: http://localhost:3000
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨ gunicorn
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:3000 app_new:app

# æˆ–ä½¿ç”¨ uWSGI
pip install uwsgi
uwsgi --http :3000 --wsgi-file app_new.py --callable app
```

### Nginx åå‘ä»£ç†

```nginx
server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ç›‘æ§å»ºè®®

### 1. æ—¥å¿—ç›‘æ§

- ä½¿ç”¨ ELK Stack æ”¶é›†æ—¥å¿—
- è®¾ç½®å‘Šè­¦è§„åˆ™

### 2. æ€§èƒ½ç›‘æ§

- ä½¿ç”¨ APM å·¥å…·ï¼ˆå¦‚ New Relicï¼‰
- ç›‘æ§å“åº”æ—¶é—´

### 3. ä¸šåŠ¡ç›‘æ§

- é¢‘é“è·å–æˆåŠŸç‡
- è´¦æˆ·çŠ¶æ€ç›‘æ§
- API è°ƒç”¨ç»Ÿè®¡

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [IPTVåŠŸèƒ½è¯´æ˜.md](IPTVåŠŸèƒ½è¯´æ˜.md) - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- ğŸš€ [å¿«é€Ÿå¼€å§‹.md](å¿«é€Ÿå¼€å§‹.md) - å…¥é—¨æŒ‡å—
- ğŸ“ [æ ¸å¿ƒåŠŸèƒ½æ¢å¤æŠ¥å‘Š.md](æ ¸å¿ƒåŠŸèƒ½æ¢å¤æŠ¥å‘Š.md) - åŠŸèƒ½æ¢å¤è¯´æ˜

## æ€»ç»“

æœ¬é¡¹ç›®é‡‡ç”¨ç»å…¸çš„ 5 å±‚æ¶æ„è®¾è®¡ï¼š

- âœ… **Routes**: æ¸…æ™°çš„ API ç«¯ç‚¹
- âœ… **Services**: ç‹¬ç«‹çš„ä¸šåŠ¡é€»è¾‘
- âœ… **Models**: è§„èŒƒçš„æ•°æ®æ¨¡å‹
- âœ… **Utils**: é€šç”¨çš„å·¥å…·å‡½æ•°
- âœ… **Config**: çµæ´»çš„é…ç½®ç®¡ç†

ç‰¹ç‚¹ï¼š
- ğŸ¯ **é«˜å†…èšä½è€¦åˆ**ï¼šå„å±‚èŒè´£æ˜ç¡®
- ğŸ”§ **æ˜“äºæ‰©å±•**ï¼šè“å›¾æ¨¡å¼ï¼Œæ’ä»¶åŒ–è®¾è®¡
- ğŸ§ª **ä¾¿äºæµ‹è¯•**ï¼šæœåŠ¡å±‚ç‹¬ç«‹ï¼Œå¯å•ç‹¬æµ‹è¯•
- ğŸ“ **æ–‡æ¡£å®Œå–„**ï¼šä»£ç æ³¨é‡Š + æ–‡æ¡£é½å…¨
- ğŸ”’ **å®‰å…¨å¯é **ï¼šJWT è®¤è¯ + å‚æ•°åŒ–æŸ¥è¯¢
