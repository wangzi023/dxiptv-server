# å¿«é€Ÿå¼€å§‹ï¼šä½¿ç”¨ IPTV åŠŸèƒ½

## ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡è´¦æˆ·ä¿¡æ¯

ä½ éœ€è¦ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **IPTV è´¦å·**ï¼šå¦‚ `0758xxxxxxx@iptv.gd`
2. **IPTV å¯†ç **ï¼šè´¦å·å¯¹åº”çš„å¯†ç 
3. **æœºé¡¶ç›’ MAC åœ°å€**ï¼šå¦‚ `XX:D8:F3:73:09:YY`

## ç¬¬äºŒæ­¥ï¼šæ·»åŠ è´¦æˆ·åˆ°æ•°æ®åº“

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ SQL

```sql
-- 1. å…ˆåˆ›å»ºä¸€ä¸ªç›´æ’­æº
INSERT INTO sources (name, status) 
VALUES ('å¹¿ä¸œç”µä¿¡ IPTV', 'active');

-- å‡è®¾è¿”å›çš„ source_id ä¸º 1

-- 2. åˆ›å»ºè´¦æˆ·å¹¶å…³è”ç›´æ’­æº
INSERT INTO accounts (username, password, mac, source_id, status)
VALUES ('0758xxxxxxx@iptv.gd', 'your_password', 'XX:D8:F3:73:09:YY', 1, 'active');
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Python

```python
from app.utils.database import execute_update

# 1. åˆ›å»ºç›´æ’­æº
source_id = execute_update(
    "INSERT INTO sources (name, status) VALUES (?, ?)",
    ('å¹¿ä¸œç”µä¿¡ IPTV', 'active')
)

# 2. åˆ›å»ºè´¦æˆ·
execute_update("""
    INSERT INTO accounts (username, password, mac, source_id, status)
    VALUES (?, ?, ?, ?, ?)
""", (
    '0758xxxxxxx@iptv.gd',
    'your_password',
    'XX:D8:F3:73:09:YY',
    source_id,
    'active'
))
```

## ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
cd d:\itcast\dxiptv-server
python tests/test_tellyget.py
```

æŒ‰æç¤ºè¾“å…¥ä¿¡æ¯ï¼š
```
è´¦å·ï¼ˆä¸å« @iptv.gdï¼‰: 0758xxxxxxx
å¯†ç : your_password
MAC åœ°å€ï¼ˆå¦‚ XX:D8:F3:73:09:YYï¼‰: XX:D8:F3:73:09:YY
```

å¦‚æœæˆåŠŸï¼Œä¼šæ˜¾ç¤ºï¼š
```
âœ… æˆåŠŸè·å– 100 ä¸ªé¢‘é“

å‰ 10 ä¸ªé¢‘é“ï¼š
 1. CCTV1é«˜æ¸…
    ID: 1
    URL: rtsp://...
    Logo: http://...
 2. CCTV2é«˜æ¸…
    ...
```

## ç¬¬å››æ­¥ï¼šé€šè¿‡ API è·å–é¢‘é“

### 1. ç™»å½•è·å– Token

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

è¿”å›ï¼š
```json
{
    "success": true,
    "token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "user": {...}
}
```

### 2. è·å–å¹¶ä¿å­˜é¢‘é“

```bash
curl -X POST http://localhost:3000/api/iptv/fetch \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..." \
  -d '{
    "account_id": 1,
    "filter_sd": true
  }'
```

è¿”å›ï¼š
```json
{
    "success": true,
    "message": "æˆåŠŸä¿å­˜ 100 ä¸ªé¢‘é“",
    "channel_count": 100
}
```

### 3. æŸ¥è¯¢é¢‘é“åˆ—è¡¨

```bash
curl -X GET "http://localhost:3000/api/iptv/channels/1?status=1" \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..."
```

è¿”å›ï¼š
```json
{
    "success": true,
    "channels": [
        {
            "id": 1,
            "channel_id": "1",
            "channel_name": "CCTV1é«˜æ¸…",
            "channel_url": "rtsp://...",
            "status": 1
        },
        ...
    ]
}
```

### 4. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```bash
curl -X GET http://localhost:3000/api/iptv/statistics/1 \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..."
```

è¿”å›ï¼š
```json
{
    "success": true,
    "statistics": {
        "total": 100,
        "active": 90,
        "inactive": 10
    }
}
```

## ç¬¬äº”æ­¥ï¼šåœ¨ä»£ç ä¸­ä½¿ç”¨

### æœåŠ¡å±‚ç¤ºä¾‹

```python
from app.services.iptv_service import IPTVService

# è·å–å¹¶ä¿å­˜é¢‘é“
result = IPTVService.fetch_and_save_channels(
    account_id=1,
    filter_sd=True,                    # è¿‡æ»¤æ ‡æ¸…
    channel_filters=[r'^\d+$', r'æµ‹è¯•']  # è¿‡æ»¤çº¯æ•°å­—å’ŒåŒ…å«"æµ‹è¯•"çš„é¢‘é“
)

if result['success']:
    print(f"æˆåŠŸï¼š{result['message']}")
    print(f"é¢‘é“æ•°ï¼š{result['channel_count']}")
else:
    print(f"å¤±è´¥ï¼š{result['message']}")

# æŸ¥è¯¢é¢‘é“
channels = IPTVService.get_channels_by_source(
    source_id=1,
    status=1  # åªæŸ¥è¯¢å¯ç”¨çš„é¢‘é“
)

for ch in channels:
    print(f"{ch['channel_name']}: {ch['channel_url']}")

# æ›´æ–°é¢‘é“çŠ¶æ€
IPTVService.update_channel_status(
    channel_id=1,
    status=0  # ç¦ç”¨
)

# è·å–ç»Ÿè®¡
stats = IPTVService.get_channel_statistics(source_id=1)
print(f"æ€»è®¡: {stats['total']}, å¯ç”¨: {stats['active']}")
```

### æ ¸å¿ƒå±‚ç¤ºä¾‹

```python
from app.utils.tellyget_core import TellyGetCore

# åˆ›å»ºå®ä¾‹
core = TellyGetCore(
    user='0758xxxxxxx',
    passwd='your_password',
    mac='XX:D8:F3:73:09:YY',
    imei='',           # å¯é€‰
    address=''         # å¯é€‰
)

# è·å–é¢‘é“
success, result = core.fetch_channels(
    filter_sd=True,
    channel_filters=None
)

if success:
    channels = result
    
    # è§£æé¢‘é“ä¿¡æ¯
    for channel in channels[:5]:
        info = TellyGetCore.parse_channel_info(channel)
        print(f"é¢‘é“å: {info['channel_name']}")
        print(f"é¢‘é“URL: {info['channel_url']}")
        print(f"Logo: {info['channel_logo_url']}")
        print("-" * 40)
else:
    print(f"é”™è¯¯: {result}")
```

## å¸¸è§é—®é¢˜

### Q1: è®¤è¯å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®
2. MAC åœ°å€æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆXX:XX:XX:XX:XX:XXï¼‰
3. ç½‘ç»œæ˜¯å¦è¿é€š
4. æŸ¥çœ‹æ—¥å¿—ï¼š`logs/tellyget_core.log`

### Q2: ä¸ºä»€ä¹ˆè·å–ä¸åˆ°é¢‘é“ï¼Ÿ

**A**: å¯èƒ½çš„åŸå› ï¼š
1. è®¤è¯æœªæˆåŠŸ
2. è´¦å·æ²¡æœ‰æƒé™
3. æœåŠ¡å™¨é™æµ
4. ç½‘ç»œé—®é¢˜

### Q3: å¦‚ä½•è¿‡æ»¤ç‰¹å®šé¢‘é“ï¼Ÿ

**A**: ä½¿ç”¨ `channel_filters` å‚æ•°ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼š

```python
# è¿‡æ»¤æ‰çº¯æ•°å­—é¢‘é“å
channel_filters = [r'^\d+$']

# è¿‡æ»¤æ‰åŒ…å«"æµ‹è¯•"çš„é¢‘é“
channel_filters = [r'æµ‹è¯•']

# ç»„åˆè¿‡æ»¤
channel_filters = [r'^\d+$', r'æµ‹è¯•', r'ä¸´æ—¶']
```

### Q4: é¢‘é“ URL æ€ä¹ˆæ’­æ”¾ï¼Ÿ

**A**: 
- RTSP åè®®ï¼šä½¿ç”¨ VLCã€PotPlayer ç­‰æ’­æ”¾å™¨
- HTTP åè®®ï¼šå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨æˆ– video æ ‡ç­¾ä¸­æ’­æ”¾

### Q5: å¦‚ä½•å®šæ—¶æ›´æ–°é¢‘é“ï¼Ÿ

**A**: å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

**æ–¹å¼ä¸€ï¼šLinux Cron**
```bash
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ›´æ–°
0 2 * * * cd /path/to/project && python -c "from app.services.iptv_service import IPTVService; IPTVService.fetch_and_save_channels(1)"
```

**æ–¹å¼äºŒï¼šPython APScheduler**
```python
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()
scheduler.add_job(
    lambda: IPTVService.fetch_and_save_channels(1),
    'cron',
    hour=2,
    minute=0
)
scheduler.start()
```

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æŒæ¡äº†åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥ï¼š

1. ğŸ“ å¼€å‘å‰ç«¯ç•Œé¢å±•ç¤ºé¢‘é“åˆ—è¡¨
2. ğŸ”„ å®ç°è‡ªåŠ¨å®šæ—¶æ›´æ–°åŠŸèƒ½
3. ğŸ“Š æ·»åŠ é¢‘é“åˆ†ç±»å’Œæœç´¢åŠŸèƒ½
4. ğŸ¯ é›†æˆæ’­æ”¾å™¨å®ç°åœ¨çº¿è§‚çœ‹
5. ğŸ“± å¼€å‘ç§»åŠ¨ç«¯ APP

## éœ€è¦å¸®åŠ©ï¼Ÿ

- æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ï¼š[docs/IPTVåŠŸèƒ½è¯´æ˜.md](IPTVåŠŸèƒ½è¯´æ˜.md)
- æŸ¥çœ‹æºä»£ç æ³¨é‡Š
- æŸ¥çœ‹æµ‹è¯•ç¤ºä¾‹ï¼š[tests/test_tellyget.py](../tests/test_tellyget.py)
