# 使用流程

## 流程图

### 1. 初次使用流程

```
开始
  ↓
安装依赖
  ├─> pip install -r requirements.txt
  ↓
启动服务
  ├─> python app_new.py
  ├─> 服务启动在 http://localhost:3000
  ↓
登录系统
  ├─> POST /api/auth/login
  ├─> 用户名: admin
  ├─> 密码: admin123
  ├─> 获得 JWT Token
  ↓
准备 IPTV 账户
  ├─> 在数据库中添加 source (直播源)
  ├─> 在数据库中添加 account (IPTV 账户)
  ├─> 填写：username, password, mac, source_id
  ↓
测试核心功能
  ├─> python tests/test_tellyget.py
  ├─> 输入账号、密码、MAC
  ├─> 查看是否能获取到频道
  ↓
通过 API 获取频道
  ├─> POST /api/iptv/fetch
  ├─> 传入 account_id
  ├─> 等待 8-15 秒
  ├─> 频道保存到数据库
  ↓
查看频道列表
  ├─> GET /api/iptv/channels/<source_id>
  ├─> 查看频道名称、URL、Logo
  ↓
完成
```

### 2. 日常使用流程

```
开始
  ↓
登录
  ├─> POST /api/auth/login
  ↓
选择功能
  ├─> A. 获取新频道
  │    ├─> POST /api/iptv/fetch
  │    ├─> 选择 account_id
  │    └─> 等待完成
  │
  ├─> B. 查看频道列表
  │    ├─> GET /api/iptv/channels/<source_id>
  │    └─> 筛选启用/禁用频道
  │
  ├─> C. 管理频道状态
  │    ├─> PUT /api/iptv/channels/<channel_id>/status
  │    └─> 启用 (1) 或禁用 (0)
  │
  ├─> D. 查看统计
  │    ├─> GET /api/iptv/statistics/<source_id>
  │    └─> 总数/启用/禁用
  │
  └─> E. 删除频道
       ├─> DELETE /api/iptv/channels/source/<source_id>
       └─> 删除所有频道
  ↓
完成
```

### 3. IPTV 获取详细流程

```
API 请求
  ├─> POST /api/iptv/fetch
  ├─> Body: { "account_id": 1, "filter_sd": true }
  ↓
路由层 (iptv.py)
  ├─> 验证 JWT Token
  ├─> 解析请求参数
  ├─> @token_required 装饰器
  ↓
服务层 (iptv_service.py)
  ├─> IPTVService.fetch_and_save_channels()
  ├─> 1. 查询账户信息
  ├─> 2. 创建 TellyGetCore 实例
  ├─> 3. 调用 fetch_channels()
  ↓
核心层 (tellyget_core.py)
  ├─> IPTVAuth.authenticate()
  │    ├─> 获取 Base URL
  │    │    └─> GET http://eds.iptv.gd.cn:8082/EDS/jsp/AuthenticationURL
  │    ├─> 获取 Token
  │    │    └─> GET {base_url}/EPG/oauth/v2/authorize
  │    ├─> 构建认证信息
  │    │    ├─> 明文: random$token$user$imei$ip$mac$$CTC
  │    │    ├─> 密钥: MD5(password)[:24].upper()
  │    │    └─> DES3 加密
  │    └─> OAuth 登录
  │         └─> GET {base_url}/EPG/oauth/v2/token
  │
  ├─> IPTVChannelFetcher.get_channels()
  │    ├─> POST {base_url}/EPG/jsp/getchannellistHWCTC.jsp
  │    ├─> BeautifulSoup 解析 HTML
  │    ├─> 查找 <script> 标签
  │    ├─> 正则匹配: Authentication.CTCSetConfig('Channel','...')
  │    ├─> 解析频道参数
  │    │    └─> ChannelID, ChannelName, ChannelURL, Logo...
  │    ├─> 应用过滤器
  │    │    ├─> 自定义正则过滤
  │    │    └─> 移除标清候选（如有高清版）
  │    └─> 返回频道列表
  ↓
服务层 (iptv_service.py)
  ├─> _save_channels_to_db()
  ├─> 遍历每个频道
  │    ├─> 检查是否已存在
  │    ├─> 存在则更新
  │    └─> 不存在则插入
  ├─> 更新账户状态
  │    └─> last_fetch_time, last_fetch_status
  ↓
返回结果
  ├─> { "success": true, "channel_count": 100 }
  └─> 耗时约 8-15 秒
```

## 关键步骤说明

### 步骤 1: 准备 IPTV 账户

**SQL 示例**:
```sql
-- 1. 创建直播源
INSERT INTO sources (name, status) 
VALUES ('广东电信 IPTV', 'active');

-- 2. 创建账户（假设 source_id = 1）
INSERT INTO accounts (username, password, mac, source_id, status)
VALUES ('0758xxxxxxx@iptv.gd', 'your_password', 'XX:D8:F3:73:09:YY', 1, 'active');
```

### 步骤 2: 获取频道

**cURL 示例**:
```bash
# 1. 登录
TOKEN=$(curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.token')

# 2. 获取频道
curl -X POST http://localhost:3000/api/iptv/fetch \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "account_id": 1,
    "filter_sd": true,
    "channel_filters": []
  }'
```

### 步骤 3: 查看结果

**查询数据库**:
```sql
-- 查看频道数量
SELECT COUNT(*) as count FROM channels WHERE source_id = 1;

-- 查看前 10 个频道
SELECT channel_name, channel_url 
FROM channels 
WHERE source_id = 1 
LIMIT 10;

-- 统计频道状态
SELECT 
    status,
    COUNT(*) as count
FROM channels 
WHERE source_id = 1
GROUP BY status;
```

**API 查询**:
```bash
# 获取频道列表
curl http://localhost:3000/api/iptv/channels/1 \
  -H "Authorization: Bearer $TOKEN"

# 获取统计信息
curl http://localhost:3000/api/iptv/statistics/1 \
  -H "Authorization: Bearer $TOKEN"
```

## 常见场景

### 场景 1: 首次获取频道

```
1. 添加 IPTV 账户到数据库
2. 运行测试脚本验证
   └─> python tests/test_tellyget.py
3. 通过 API 获取频道
   └─> POST /api/iptv/fetch
4. 查看频道列表
   └─> GET /api/iptv/channels/1
```

### 场景 2: 更新频道

```
1. 删除旧频道
   └─> DELETE /api/iptv/channels/source/1
2. 重新获取
   └─> POST /api/iptv/fetch
3. 验证新频道
   └─> GET /api/iptv/statistics/1
```

### 场景 3: 管理频道状态

```
1. 查看所有频道
   └─> GET /api/iptv/channels/1
2. 禁用不需要的频道
   └─> PUT /api/iptv/channels/123/status
   └─> { "status": 0 }
3. 查看启用的频道
   └─> GET /api/iptv/channels/1?status=1
```

### 场景 4: 定期更新

```python
# 使用 APScheduler
from apscheduler.schedulers.background import BackgroundScheduler
from app.services.iptv_service import IPTVService

scheduler = BackgroundScheduler()

def update_channels():
    # 删除旧频道
    IPTVService.delete_channels_by_source(1)
    
    # 获取新频道
    result = IPTVService.fetch_and_save_channels(
        account_id=1,
        filter_sd=True
    )
    
    print(f"更新完成: {result['message']}")

# 每天凌晨 2 点更新
scheduler.add_job(update_channels, 'cron', hour=2, minute=0)
scheduler.start()
```

## 错误处理

### 错误 1: 认证失败

**症状**: `认证失败` 或 `获取频道失败: 认证失败`

**排查步骤**:
```
1. 检查账号密码是否正确
   └─> SELECT username, password FROM accounts WHERE id = 1;

2. 检查 MAC 地址格式
   └─> 格式：XX:XX:XX:XX:XX:XX

3. 测试网络连接
   └─> curl http://eds.iptv.gd.cn:8082/EDS/jsp/AuthenticationURL

4. 查看日志
   └─> cat logs/tellyget_core.log
```

### 错误 2: 频道数量为 0

**症状**: `成功保存 0 个频道`

**排查步骤**:
```
1. 检查账户状态
   └─> SELECT * FROM accounts WHERE id = 1;

2. 查看最后获取状态
   └─> SELECT last_fetch_status FROM accounts WHERE id = 1;

3. 测试核心功能
   └─> python tests/test_tellyget.py

4. 检查过滤器
   └─> 可能过滤掉了所有频道
```

### 错误 3: 数据库保存失败

**症状**: `保存频道失败`

**排查步骤**:
```
1. 检查 source_id 是否存在
   └─> SELECT * FROM sources WHERE id = 1;

2. 检查账户是否关联直播源
   └─> SELECT source_id FROM accounts WHERE id = 1;

3. 查看数据库日志
   └─> cat logs/iptv_service.log

4. 手动测试插入
   └─> 运行 SQL INSERT 测试
```

## 最佳实践

### 1. 账户管理

- ✅ 使用真实的 IPTV 账户
- ✅ 定期检查账户状态
- ✅ 记录最后获取时间

### 2. 频道管理

- ✅ 开启 filter_sd（过滤标清）
- ✅ 定期更新频道列表
- ✅ 及时禁用失效频道

### 3. 性能优化

- ✅ 使用数据库索引
- ✅ 避免频繁获取
- ✅ 考虑使用缓存

### 4. 安全考虑

- ✅ 加密存储密码
- ✅ 使用 JWT 认证
- ✅ 限制 API 访问频率

## 时间估算

| 操作 | 预计耗时 |
|------|----------|
| 安装依赖 | 1-2 分钟 |
| 启动服务 | 5-10 秒 |
| 添加账户 | 1 分钟 |
| 测试核心功能 | 8-15 秒 |
| API 获取频道 | 8-15 秒 |
| 查看频道列表 | < 1 秒 |
| 更新频道状态 | < 1 秒 |

**总计（首次使用）**: 约 5-10 分钟

## 相关文档

- 📖 [IPTV功能说明.md](IPTV功能说明.md) - 完整技术文档
- 🚀 [快速开始.md](快速开始.md) - 入门指南
- 📝 [核心功能恢复报告.md](核心功能恢复报告.md) - 功能说明
- 🏗️ [项目架构.md](项目架构.md) - 架构说明
- 📋 [README.md](../README.md) - 项目主文档

## 总结

流程概览：
1. **准备** → 安装依赖，启动服务
2. **配置** → 添加 IPTV 账户
3. **测试** → 验证核心功能
4. **使用** → API 获取频道
5. **管理** → 查看和管理频道

记住：
- 🔑 需要真实 IPTV 账户
- ⏱️ 获取过程需要 8-15 秒
- 📊 使用统计接口监控状态
- 🔄 定期更新频道列表
